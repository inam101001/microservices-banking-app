name: CI/CD Pipeline - Build and Deploy

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

env:
  DOCKERHUB_USERNAME: inam101001
  IMAGE_TAG: sha-${{ github.sha }}

jobs:
  detect-changes:
    name: Detect Changed Services
    runs-on: ubuntu-latest
    outputs:
      user-service: ${{ steps.changes.outputs.user-service }}
      account-service: ${{ steps.changes.outputs.account-service }}
      transaction-service: ${{ steps.changes.outputs.transaction-service }}
      notification-service: ${{ steps.changes.outputs.notification-service }}
      frontend: ${{ steps.changes.outputs.frontend }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changes
        id: changes
        run: |
          # Check for changes in each service directory
          if git diff --name-only HEAD~1 HEAD | grep -E "^user_service/" > /dev/null; then
            echo "user-service=true" >> $GITHUB_OUTPUT
          else
            echo "user-service=false" >> $GITHUB_OUTPUT
          fi

          if git diff --name-only HEAD~1 HEAD | grep -E "^account_service/" > /dev/null; then
            echo "account-service=true" >> $GITHUB_OUTPUT
          else
            echo "account-service=false" >> $GITHUB_OUTPUT
          fi

          if git diff --name-only HEAD~1 HEAD | grep -E "^transaction_service/" > /dev/null; then
            echo "transaction-service=true" >> $GITHUB_OUTPUT
          else
            echo "transaction-service=false" >> $GITHUB_OUTPUT
          fi

          if git diff --name-only HEAD~1 HEAD | grep -E "^notification_service/" > /dev/null; then
            echo "notification-service=true" >> $GITHUB_OUTPUT
          else
            echo "notification-service=false" >> $GITHUB_OUTPUT
          fi

          if git diff --name-only HEAD~1 HEAD | grep -E "^frontend/" > /dev/null; then
            echo "frontend=true" >> $GITHUB_OUTPUT
          else
            echo "frontend=false" >> $GITHUB_OUTPUT
          fi

  build-user-service:
    name: Build User Service
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.user-service == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./user_service
          file: ./user_service/Dockerfile
          push: true
          tags: |
            ${{ env.DOCKERHUB_USERNAME }}/user-service:${{ env.IMAGE_TAG }}
            ${{ env.DOCKERHUB_USERNAME }}/user-service:latest
          cache-from: type=registry,ref=${{ env.DOCKERHUB_USERNAME }}/user-service:buildcache
          cache-to: type=registry,ref=${{ env.DOCKERHUB_USERNAME }}/user-service:buildcache,mode=max

      - name: Run Trivy security scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.DOCKERHUB_USERNAME }}/user-service:${{ env.IMAGE_TAG }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  build-account-service:
    name: Build Account Service
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.account-service == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./account_service
          file: ./account_service/Dockerfile
          push: true
          tags: |
            ${{ env.DOCKERHUB_USERNAME }}/account-service:${{ env.IMAGE_TAG }}
            ${{ env.DOCKERHUB_USERNAME }}/account-service:latest
          cache-from: type=registry,ref=${{ env.DOCKERHUB_USERNAME }}/account-service:buildcache
          cache-to: type=registry,ref=${{ env.DOCKERHUB_USERNAME }}/account-service:buildcache,mode=max

      - name: Run Trivy security scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.DOCKERHUB_USERNAME }}/account-service:${{ env.IMAGE_TAG }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  build-transaction-service:
    name: Build Transaction Service
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.transaction-service == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./transaction_service
          file: ./transaction_service/Dockerfile
          push: true
          tags: |
            ${{ env.DOCKERHUB_USERNAME }}/transaction-service:${{ env.IMAGE_TAG }}
            ${{ env.DOCKERHUB_USERNAME }}/transaction-service:latest
          cache-from: type=registry,ref=${{ env.DOCKERHUB_USERNAME }}/transaction-service:buildcache
          cache-to: type=registry,ref=${{ env.DOCKERHUB_USERNAME }}/transaction-service:buildcache,mode=max

      - name: Run Trivy security scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.DOCKERHUB_USERNAME }}/transaction-service:${{ env.IMAGE_TAG }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  build-notification-service:
    name: Build Notification Service
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.notification-service == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./notification_service
          file: ./notification_service/Dockerfile
          push: true
          tags: |
            ${{ env.DOCKERHUB_USERNAME }}/notification-service:${{ env.IMAGE_TAG }}
            ${{ env.DOCKERHUB_USERNAME }}/notification-service:latest
          cache-from: type=registry,ref=${{ env.DOCKERHUB_USERNAME }}/notification-service:buildcache
          cache-to: type=registry,ref=${{ env.DOCKERHUB_USERNAME }}/notification-service:buildcache,mode=max

      - name: Run Trivy security scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.DOCKERHUB_USERNAME }}/notification-service:${{ env.IMAGE_TAG }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./frontend/Dockerfile
          push: true
          tags: |
            ${{ env.DOCKERHUB_USERNAME }}/frontend:${{ env.IMAGE_TAG }}
            ${{ env.DOCKERHUB_USERNAME }}/frontend:latest
          cache-from: type=registry,ref=${{ env.DOCKERHUB_USERNAME }}/frontend:buildcache
          cache-to: type=registry,ref=${{ env.DOCKERHUB_USERNAME }}/frontend:buildcache,mode=max

      - name: Run Trivy security scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.DOCKERHUB_USERNAME }}/frontend:${{ env.IMAGE_TAG }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  update-manifests:
    name: Update Kubernetes Manifests
    runs-on: ubuntu-latest
    needs: 
      - build-user-service
      - build-account-service
      - build-transaction-service
      - build-notification-service
      - build-frontend
    if: |
      always() && 
      github.event_name == 'push' && 
      github.ref == 'refs/heads/master' &&
      (needs.build-user-service.result == 'success' || 
       needs.build-account-service.result == 'success' || 
       needs.build-transaction-service.result == 'success' || 
       needs.build-notification-service.result == 'success' || 
       needs.build-frontend.result == 'success')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Update user-service manifest
        if: needs.build-user-service.result == 'success'
        run: |
          sed -i "s|image: ${{ env.DOCKERHUB_USERNAME }}/user-service:.*|image: ${{ env.DOCKERHUB_USERNAME }}/user-service:${{ env.IMAGE_TAG }}|g" k8s/manifests/user-service/deployment.yaml

      - name: Update account-service manifest
        if: needs.build-account-service.result == 'success'
        run: |
          sed -i "s|image: ${{ env.DOCKERHUB_USERNAME }}/account-service:.*|image: ${{ env.DOCKERHUB_USERNAME }}/account-service:${{ env.IMAGE_TAG }}|g" k8s/manifests/account-service/deployment.yaml

      - name: Update transaction-service manifest
        if: needs.build-transaction-service.result == 'success'
        run: |
          sed -i "s|image: ${{ env.DOCKERHUB_USERNAME }}/transaction-service:.*|image: ${{ env.DOCKERHUB_USERNAME }}/transaction-service:${{ env.IMAGE_TAG }}|g" k8s/manifests/transaction-service/deployment.yaml

      - name: Update notification-service manifest
        if: needs.build-notification-service.result == 'success'
        run: |
          sed -i "s|image: ${{ env.DOCKERHUB_USERNAME }}/notification-service:.*|image: ${{ env.DOCKERHUB_USERNAME }}/notification-service:${{ env.IMAGE_TAG }}|g" k8s/manifests/notification-service/deployment.yaml

      - name: Update frontend manifest
        if: needs.build-frontend.result == 'success'
        run: |
          sed -i "s|image: ${{ env.DOCKERHUB_USERNAME }}/frontend:.*|image: ${{ env.DOCKERHUB_USERNAME }}/frontend:${{ env.IMAGE_TAG }}|g" k8s/manifests/frontend/deployment.yaml

      - name: Commit and push changes
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          git add k8s/manifests/*/deployment.yaml
          git diff --staged --quiet || git commit -m "chore: update image tags to ${{ env.IMAGE_TAG }}"
          git push

  notify:
    name: Notify Build Status
    runs-on: ubuntu-latest
    needs:
      - build-user-service
      - build-account-service
      - build-transaction-service
      - build-notification-service
      - build-frontend
      - update-manifests
    if: always()
    steps:
      - name: Prepare notification message
        id: message
        run: |
          STATUS="âœ… Success"
          if [ "${{ contains(needs.*.result, 'failure') }}" == "true" ]; then
            STATUS="âŒ Failed"
          fi
          
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "commit=${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "branch=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          echo "author=${{ github.actor }}" >> $GITHUB_OUTPUT

      - name: Print summary
        run: |
          echo "### ðŸš€ CI/CD Pipeline Summary"
          echo ""
          echo "**Status:** ${{ steps.message.outputs.status }}"
          echo "**Commit:** ${{ steps.message.outputs.commit }}"
          echo "**Branch:** ${{ steps.message.outputs.branch }}"
          echo "**Author:** ${{ steps.message.outputs.author }}"
          echo ""
          echo "**Build Results:**"
          echo "- User Service: ${{ needs.build-user-service.result }}"
          echo "- Account Service: ${{ needs.build-account-service.result }}"
          echo "- Transaction Service: ${{ needs.build-transaction-service.result }}"
          echo "- Notification Service: ${{ needs.build-notification-service.result }}"
          echo "- Frontend: ${{ needs.build-frontend.result }}"
          echo "- Manifest Update: ${{ needs.update-manifests.result }}"
