name: Manual Service Deployment

on:
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to deploy'
        required: true
        type: choice
        options:
          - user-service
          - account-service
          - transaction-service
          - notification-service
          - frontend
      image_tag:
        description: 'Image tag to deploy (e.g., sha-abc123 or latest)'
        required: true
        default: 'latest'
      reason:
        description: 'Reason for manual deployment'
        required: false

env:
  DOCKERHUB_USERNAME: inam101001

jobs:
  deploy:
    name: Deploy ${{ inputs.service }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Validate image exists
        run: |
          # Check if the image exists in DockerHub
          TOKEN=$(curl -s -H "Content-Type: application/json" -X POST \
            -d '{"username": "${{ secrets.DOCKERHUB_USERNAME }}", "password": "${{ secrets.DOCKERHUB_TOKEN }}"}' \
            https://hub.docker.com/v2/users/login/ | jq -r .token)
          
          RESPONSE=$(curl -s -H "Authorization: JWT ${TOKEN}" \
            https://hub.docker.com/v2/repositories/${{ env.DOCKERHUB_USERNAME }}/${{ inputs.service }}/tags/${{ inputs.image_tag }}/)
          
          if echo "$RESPONSE" | grep -q "error"; then
            echo "‚ùå Error: Image ${{ env.DOCKERHUB_USERNAME }}/${{ inputs.service }}:${{ inputs.image_tag }} not found"
            exit 1
          else
            echo "‚úÖ Image found: ${{ env.DOCKERHUB_USERNAME }}/${{ inputs.service }}:${{ inputs.image_tag }}"
          fi

      - name: Update manifest
        run: |
          # Update the deployment manifest with the specified image tag
          sed -i "s|image: ${{ env.DOCKERHUB_USERNAME }}/${{ inputs.service }}:.*|image: ${{ env.DOCKERHUB_USERNAME }}/${{ inputs.service }}:${{ inputs.image_tag }}|g" k8s/manifests/${{ inputs.service }}/deployment.yaml

      - name: Commit and push changes
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          git add k8s/manifests/${{ inputs.service }}/deployment.yaml
          
          COMMIT_MSG="deploy: manual deployment of ${{ inputs.service }} with tag ${{ inputs.image_tag }}"
          if [ -n "${{ inputs.reason }}" ]; then
            COMMIT_MSG="${COMMIT_MSG}\n\nReason: ${{ inputs.reason }}"
          fi
          
          git commit -m "${COMMIT_MSG}"
          git push

      - name: Deployment summary
        run: |
          echo "### üöÄ Manual Deployment Summary"
          echo ""
          echo "**Service:** ${{ inputs.service }}"
          echo "**Image Tag:** ${{ inputs.image_tag }}"
          echo "**Full Image:** ${{ env.DOCKERHUB_USERNAME }}/${{ inputs.service }}:${{ inputs.image_tag }}"
          if [ -n "${{ inputs.reason }}" ]; then
            echo "**Reason:** ${{ inputs.reason }}"
          fi
          echo ""
          echo "**Status:** ‚úÖ Manifest updated and pushed to Git"
          echo "**Next:** ArgoCD will automatically sync this change to Kubernetes"

      - name: Wait for ArgoCD sync (optional)
        run: |
          echo "‚è≥ ArgoCD will detect the change within 3 minutes"
          echo "üîç Check ArgoCD UI for sync status: http://localhost:8080"
          echo ""
          echo "To check sync status manually:"
          echo "kubectl get application ${{ inputs.service }} -n argocd"